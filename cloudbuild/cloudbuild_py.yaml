steps:
  - name: "bash"
    id: PY_DIST_DIR
    script: |
      #!/usr/bin/env bash
      mkdir -p ${DIST_DIR}
    dir: "${_CODE_DIR}"
  - name: "python"
    id: PY_MINIMUM
    entrypoint: "python3"
    args: ["-m", "pip", "install", "--user", "--upgrade",
           "pip", "wheel", "setuptools"]
    waitFor:
      - PY_DIST_DIR
  - name: "python"
    id: PY_BUILD_DEPENDENCIES
    entrypoint: "python3"
    args: ["-m", "pip", "install", "--user", ".[all]"]
    dir: "${_CODE_DIR}"
  - name: "python"
    id: PY_BUILD
    entrypoint: "python3"
    args: ["./setup.py", "build", "--force"]
    dir: "${_CODE_DIR}"
  - name: "python"
    id: PY_LINT
    entrypoint: "python3"
    args: ["-m", "pylint",
           "--output-format=json",
           "--output=./${_DIST_DIR}/${_PYTHON_PYLINT_FILE}",
           "setup.py", "tests", "yaas"]
    dir: "${_CODE_DIR}"
    waitFor:
      - PY_BUILD
  - name: "python"
    id: PY_TESTS
    entrypoint: "python3"
    args: ["-m", "pytest",
           "-m", "not doesnt_work_cloudbuild",
           "--junitxml=./${_DIST_DIR}/${_PYTHON_PYTEST_FILE}"]
    dir: "${_CODE_DIR}"
    waitFor:
      - PY_BUILD
  - name: "python"
    id: PY_WHEEL
    entrypoint: "python3"
    args: ["./setup.py", "bdist_wheel", "--universal",
           "--build-number", "$(date -u +%s)",
           "--dist-dir", "./${_DIST_DIR}"]
    dir: "${_CODE_DIR}"

logsBucket: "gs://${_BUCKET_NAME}"

options:
  dynamic_substitutions: true
  env:
    - "DIST_DIR=${_DIST_DIR}"
  logging: LEGACY
  logStreamingOption: STREAM_DEFAULT
  machineType: E2_HIGHCPU_32

substitutions:
  _CODE_DIR: "./code"
  _DIST_DIR: "dist"
  _BUILD_NUMBER: "build_number.txt"
  _PYTHON_PYTEST_FILE: "${SHORT_SHA}_test_log.xml"
  _PYTHON_PYLINT_FILE: "${SHORT_SHA}_lint_log.json"
  _PYTHON_REPO_NAME: ""
  _AR_PIP_REPO: "${LOCATION}-python.pkg.dev/${PROJECT_ID}/${_PYTHON_REPO_NAME}"

artifacts:
  objects:
    location: "gs://${_BUCKET_NAME}/${REPO_NAME}-${BRANCH_NAME}/${BUILD_ID}"
    paths:
      - "${_CODE_DIR}/${_DIST_DIR}/${_PYTHON_PYTEST_FILE}"
      - "${_CODE_DIR}/${_DIST_DIR}/${_PYTHON_PYLINT_FILE}"
  pythonPackages:
   - repository: "${_AR_PIP_REPO}"
     paths: ["${_DIST_DIR}/*.whl"]
